#include "user_fgm_mpc.h"
#include "math.h"
//#include "mex.h"

void fgm_mpc(d_fgm x_hat[n_states], d_fgm u_opt[n_opt_var])
{
	 int i,j,k;

	 //data arrays
	d_fgm H_diff_negative[10][10] = {-0.8733537248310766,0.0132152634958877,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,0.0132152634958877,-0.9163033311927116,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.9845821925881311,0.0011012719579906,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,0.0011012719579906,-0.9746707449662153,0.0033038158739719,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,0.0033038158739719,-0.7698341607799567,0.0319368867817285,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,0.0319368867817285,-0.9713669290922434,0.0011012719579906,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,0.0011012719579906,-0.8160875830155635,0.0330381587397191,0.0044050878319626,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,0.0330381587397191,-0.8259990306374793,0.0396457904876630,0.0077089037059345,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,0.0044050878319626,0.0396457904876630,-0.8667460930831328,0.0528610539835506,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,-0.0000000000000000,0.0077089037059345,0.0528610539835506,-0.0033488780184728,};
	d_fgm h_x[20][10] = {-0.0426782891709171,0.0033826296192761,0.0000860474472514,0.0000040540267608,0.0000002211445707,0.0000000232659651,0.0000000003832765,0.0000000000225667,0.0000000000014834,0.0000000000000757,0.1600561223791899,0.0255239818119433,0.0002610004580514,0.0000086564633293,0.0000003786868587,0.0000000351525732,0.0000000005489047,0.0000000000314338,0.0000000000020305,0.0000000000001022,0.0167617488759382,0.0164064105260331,0.0023602230717106,0.0002135079421668,0.0000186174599615,0.0000024416797332,0.0000000451767781,0.0000000029260999,0.0000000002104683,0.0000000000117960,0.0344876066369559,0.1402842443941376,0.0023216609087383,0.0001168184867027,0.0000078570777123,0.0000009420637156,0.0000000168668715,0.0000000010729740,0.0000000000762234,0.0000000000042277,0.0023492132156651,0.0135264537470151,0.0107768878564446,0.0068764468582295,0.0011811584970405,0.0001852998404346,0.0000039036476132,0.0000002893412481,0.0000000237374570,0.0000000015201570,0.0010008949511905,0.0069237023537726,0.0639387975453308,0.0082508932607663,0.0010320427395233,0.0001519319701577,0.0000031170449416,0.0000002271592146,0.0000000184156823,0.0000000011681880,0.0000316089928166,0.0002742203334714,0.0041936027193442,0.0133971369315969,0.0185651685889450,0.0035618403703391,0.0000957166406560,0.0000089484657900,0.0000008879687638,0.0000000677274053,0.0000259540627897,0.0002514258651799,0.0059903421519791,0.0800593022815992,0.0214163862767483,0.0036434426204819,0.0000914486336377,0.0000082183164430,0.0000007978622647,0.0000000599862464,0.0000002628392563,0.0000030962717339,0.0000982940097460,0.0014887356536368,0.0161825774535496,-0.0005692051422473,0.0001804979242527,0.0000361791870040,0.0000051303154773,0.0000005100459680,0.0000002117442766,0.0000027820681022,0.0001218107256926,0.0034403892544108,0.1109245262487433,0.0248443656893853,0.0010954002519375,0.0001422824100427,0.0000175155033489,0.0000016257248845,0.0000000243484528,0.0000004458659315,0.0000289878361872,0.0010554288461490,0.0424372286423262,0.0233486418388679,0.0103121806119467,0.0020804766647654,0.0003201753445274,0.0000367252170685,0.0000000711326428,0.0000013313757538,0.0000891940397035,0.0033632017923684,0.1449177728146452,0.0936371429028033,0.0101932872966825,0.0017781675693446,0.0002602022667431,0.0000290477609302,0.0000000004191508,0.0000000095122177,0.0000007341619041,0.0000289951639935,0.0011887469172710,0.0003990309194869,-0.0477419130416569,0.0899678228066831,0.0270944875760788,0.0052039798867384,0.0000000003849752,0.0000000091236939,0.0000007451780182,0.0000323648816209,0.0018182771433325,0.0030241924944783,0.1930380890252329,0.0549825997094764,0.0108666775178328,0.0017019216846681,0.0000000000733490,0.0000000019784062,0.0000001790005044,0.0000085423774457,0.0005750556062772,0.0012770662800842,0.0853766666979489,-0.0917695497498211,0.0232784634565155,0.0193539764634071,0.0000000000205580,0.0000000005645452,0.0000000523175451,0.0000026034137315,0.0001945427309603,0.0005138716014459,0.0492726822038157,0.1477773750769958,0.0550979309172638,0.0160310490867538,0.0000000000029201,0.0000000000879737,0.0000000089492578,0.0000005015468160,0.0000459520676274,0.0001483213596824,0.0166462255848820,0.0657350513061711,-0.0014206712605056,0.0887254251250363,0.0000000000017073,0.0000000000518424,0.0000000053369107,0.0000003053432592,0.0000291550234952,0.0000992197438176,0.0124335767506383,0.0727158696121269,0.1593949172703995,0.1078567503947558,0.0000000000000391,0.0000000000012872,0.0000000001455521,0.0000000094109094,0.0000010649483368,0.0000041373320524,0.0005947345095691,0.0043131394760567,0.0118667197539226,0.0327208391430103,0.0000000000000329,0.0000000000010885,0.0000000001244639,0.0000000082080196,0.0000009642368727,0.0000039388389162,0.0006342459628504,0.0062547274851400,0.0333362352872458,0.4521115198851108,};
	d_fgm b_upper[10] = {0.2000000000000000,0.2000000000000000,0.2000000000000000,0.2000000000000000,0.2000000000000000,0.2000000000000000,0.2000000000000000,0.2000000000000000,0.2000000000000000,0.2000000000000000,};
	d_fgm b_lower[10] = {-0.1999000000000000,-0.1999000000000000,-0.1999000000000000,-0.1999000000000000,-0.1999000000000000,-0.1999000000000000,-0.1999000000000000,-0.1999000000000000,-0.1999000000000000,-0.1999000000000000,};
	d_fgm beta_var = 0.7801990953028164;
	d_fgm beta_plus = 1.7801990953028164;

	d_fgm Z_new[n_opt_var],Z[n_opt_var];
	d_fgm Y_new[n_opt_var], Y[n_opt_var];
	d_fgm h[n_opt_var];
	d_fgm T[n_opt_var];

	d_fgm iter_error;

	reset_grad: for(i = 0; i < n_opt_var; i++) 
	{
		#pragma HLS PIPELINE
		h[i] = 0;
	}
	grad: for(j = 0; j < n_states; j++)
	{
		grad_1: for(i = 0; i < n_opt_var; i++) 
		{
			#pragma HLS LOOP_FLATTEN
			#pragma HLS PIPELINE
			h[i] += x_hat[j] * h_x[j][i];
		}
	}

	guess_initialization: for(i = 0; i < n_opt_var; i++)
	{
		#pragma HLS PIPELINE
		Z[i] = 0;
		Y[i] = 0;
	}

	iteration_loop: for(k = 0; k < n_iter; k++)
	{
		reset_output:for(i = 0; i < n_opt_var; i++)
		{
			#pragma HLS PIPELINE
			T[i] = 0;
		}

		mv_mult:for(j = 0; j < n_opt_var; j++)
		{
			vv_mult: for(i = 0; i < n_opt_var; i++)
			{
				#pragma HLS LOOP_FLATTEN
				#pragma HLS PIPELINE
				T[i] += -H_diff_negative[i][j] * Y[j];
			}
		}

		subtract_gradient:for(i = 0; i < n_opt_var; i++)
		{
			#pragma HLS PIPELINE
			T[i] = T[i] - h[i];
		}

		projection_loop: for(i = 0; i < n_opt_var; i++)
		{
			#pragma HLS PIPELINE
			if(T[i] > b_upper[i])
			{
				Z_new[i] = b_upper[i];
			}
			else if (T[i] < b_lower[i])
			{
				Z_new[i] = b_lower[i];
			}
			else
			{
				Z_new[i] = T[i];
			}
		}

		fgm_step:for(i = 0; i < n_opt_var; i++)
		{
			#pragma HLS PIPELINE
			Y_new[i] = beta_plus * Z_new[i] - beta_var * Z[i];		
		}

		//iter_error = 0;
		update_loop: for(i=0; i < n_opt_var; i++)
		{
			#pragma HLS PIPELINE
			//iter_error += fabs(Y[i] - Y_new[i]);
			Z[i] = Z_new[i];
			Y[i] = Y_new[i];
		}
		//printf("error[%d] = %f \n",k,iter_error);
	}

	output_loop: for(i=0; i < n_opt_var; i++)
	{
		#pragma HLS PIPELINE
		u_opt[i] = Y_new[i];
	}
}
